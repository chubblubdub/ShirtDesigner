<script>
const SVG_LIST = [
  { label: "select a design…", url: "" },
  { label: "smiley", url: "https://raw.githubusercontent.com/chubblubdub/ShirtDesigner/main/smiley.svg" },
  { label: "heart", url: "https://raw.githubusercontent.com/chubblubdub/ShirtDesigner/main/heart.svg" },
  { label: "squiggle", url: "https://raw.githubusercontent.com/chubblubdub/ShirtDesigner/main/squiggle.svg" },
];
const shirtInput = document.getElementById('shirtInput');
const shirtImg = document.getElementById('shirtImg');
const stage = document.getElementById('stage');
const overlayBox = document.getElementById('overlayBox');
const overlayInner = document.getElementById('overlayInner');
const handle = overlayBox.querySelector('.handle');
const svgSelect = document.getElementById('svgSelect');
const customUrl = document.getElementById('customUrl');
const loadCustomBtn = document.getElementById('loadCustomBtn');
const colorInput = document.getElementById('color');
const opacityInput = document.getElementById('opacity');
const opacityPct = document.getElementById('opacityPct');
const scaleInput = document.getElementById('scale');
const scalePct = document.getElementById('scalePct');
const rotationInput = document.getElementById('rotation');
const rotDeg = document.getElementById('rotDeg');
const exportBtn = document.getElementById('exportBtn');
const centerBtn = document.getElementById('centerBtn');
const fitBtn = document.getElementById('fitBtn');
let sizePct = 40, rotationDeg = 0, pos = { xPct: 50, yPct: 50 }, isDragging=false, isResizing=false, dragStart={}, boxStart={};
let currentSVGEl = null;

SVG_LIST.forEach(({label,url},i)=>{
  const opt=document.createElement('option');
  opt.textContent=label; opt.value=url; if(i===0) opt.disabled=true;
  svgSelect.appendChild(opt);
});
shirtInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(file){
    const url = URL.createObjectURL(file);
    loadShirt(url);
  }
});
stage.addEventListener('dragover', e=>{e.preventDefault();});
stage.addEventListener('drop', e=>{
  e.preventDefault();
  if(e.dataTransfer.files.length){
    const file=e.dataTransfer.files[0];
    loadShirt(URL.createObjectURL(file));
  }
});
document.addEventListener('paste', e=>{
  const items = e.clipboardData.items;
  for(let item of items){
    if(item.type.indexOf("image")!==-1){
      const blob = item.getAsFile();
      loadShirt(URL.createObjectURL(blob));
    }
  }
});
function loadShirt(src){
  shirtImg.src=src;
  shirtImg.onload=()=>{
    stage.style.width=shirtImg.width+"px";
    stage.style.height=shirtImg.height+"px";
    exportBtn.disabled=false;
  };
}
svgSelect.addEventListener('change', ()=>loadSVG(svgSelect.value));
loadCustomBtn.addEventListener('click', ()=>loadSVG(customUrl.value));

async function loadSVG(url){
  if(!url) return;
  const resp=await fetch(url);
  const text=await resp.text();
  overlayInner.innerHTML=text;

  // ensure we grabbed the svg root
  currentSVGEl = overlayInner.querySelector('svg');
  if(!currentSVGEl) return;

  // remove any hardcoded width/height to make scaling % work
  currentSVGEl.removeAttribute("width");
  currentSVGEl.removeAttribute("height");

  applyColor(currentSVGEl, colorInput.value);
  overlayBox.hidden=false;
  setOverlayTransform();
}

// robust recoloring
function applyColor(root, color){
  if(!root) return;
  const elements = root.querySelectorAll("*");
  elements.forEach(el=>{
    // Only target actual drawable elements
    if(el.tagName.match(/path|circle|rect|polygon|line|ellipse|polyline/i)){
      const fill = el.getAttribute("fill");
      const stroke = el.getAttribute("stroke");

      if(fill !== "none") el.setAttribute("fill", color);
      if(stroke !== "none") el.setAttribute("stroke", color);

      // If no fill defined, set one
      if(!el.hasAttribute("fill")) el.setAttribute("fill", color);
    }
  });
}

colorInput.addEventListener('input', ()=>{
  applyColor(currentSVGEl, colorInput.value);
});
opacityInput.addEventListener('input', ()=>{
  opacityPct.textContent=opacityInput.value+"%";
  overlayBox.style.opacity=opacityInput.value/100;
});
scaleInput.addEventListener('input', ()=>{
  sizePct=parseInt(scaleInput.value);
  scalePct.textContent=sizePct+"%";
  setOverlayTransform();
});
rotationInput.addEventListener('input', ()=>{
  rotationDeg=parseInt(rotationInput.value);
  rotDeg.textContent=rotationDeg+"°";
  setOverlayTransform();
});
centerBtn.addEventListener('click', ()=>{
  pos={xPct:50,yPct:50};
  setOverlayTransform();
});
fitBtn.addEventListener('click', ()=>{
  sizePct=50; pos={xPct:50,yPct:35};
  setOverlayTransform();
});
overlayBox.addEventListener('mousedown', e=>{
  if(e.target===handle){
    isResizing=true;
  } else {
    isDragging=true;
  }
  dragStart={x:e.clientX, y:e.clientY};
  boxStart={...pos, size:sizePct};
  overlayBox.classList.add('dragging');
});
document.addEventListener('mousemove', e=>{
  if(isDragging){
    const rect=stage.getBoundingClientRect();
    const dx=(e.clientX-dragStart.x)/rect.width*100;
    const dy=(e.clientY-dragStart.y)/rect.height*100;
    pos.xPct=boxStart.xPct+dx;
    pos.yPct=boxStart.yPct+dy;
    setOverlayTransform();
  }
  if(isResizing){
    const rect=stage.getBoundingClientRect();
    const dx=(e.clientX-dragStart.x)/rect.width*100;
    sizePct=Math.max(5, boxStart.size+dx);
    scalePct.textContent=Math.round(sizePct)+"%";
    setOverlayTransform();
  }
});
document.addEventListener('mouseup', ()=>{
  isDragging=false;
  isResizing=false;
  overlayBox.classList.remove('dragging');
});
function setOverlayTransform(){
  overlayBox.style.left=pos.xPct+"%";
  overlayBox.style.top=pos.yPct+"%";
  overlayBox.style.width=sizePct+"%";
  overlayBox.style.transform=`translate(-50%,-50%) rotate(${rotationDeg}deg)`;
}
exportBtn.addEventListener('click', ()=>{
  const canvas=document.createElement('canvas');
  canvas.width=shirtImg.width;
  canvas.height=shirtImg.height;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(shirtImg,0,0);
  const svgData=new XMLSerializer().serializeToString(currentSVGEl);
  const img=new Image();
  const svgBlob=new Blob([svgData],{type:"image/svg+xml;charset=utf-8"});
  const url=URL.createObjectURL(svgBlob);
  img.onload=()=>{
    ctx.globalAlpha=overlayBox.style.opacity || 1;
    const ow=overlayBox.offsetWidth;
    const oh=overlayBox.offsetHeight;
    const ox=(pos.xPct/100)*shirtImg.width-ow/2;
    const oy=(pos.yPct/100)*shirtImg.height-oh/2;
    ctx.drawImage(img, ox, oy, ow, oh);
    const link=document.createElement('a');
    link.download="shirt_mockup.png";
    link.href=canvas.toDataURL();
    link.click();
  };
  img.src=url;
});
</script>
