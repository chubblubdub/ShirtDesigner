<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Shirt Designer Mockup</title>
<style>
body {
  margin: 0;
  background: #0f1115;
  color: #e7eaf0;
  font-family: system-ui, sans-serif;
  text-transform: lowercase;
  display: flex;
  justify-content: center;
  padding: 10px;
}
.wrap {
  display: flex;
  gap: 16px;
  max-width: 1200px;
  width: 100%;
  flex-wrap: wrap;
  justify-content: center;
}
.stage-wrap {
  background: #0b0d12;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid #111520;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}
#stage {
  position: relative;
  display: inline-block;
  background: #0b0d12;
  border-radius: 8px;
  border: 1px dashed #22283a;
}
#shirtImg {
  display: block;
  max-width: 100%;
  height: auto;
}
#overlayBox {
  position: absolute;
  border: 1px dashed #7aa2ff;
  cursor: grab;
}
#overlayBox.dragging {
  cursor: grabbing;
}
#overlayInner svg {
  width: 100%;
  height: 100%;
}
.handle {
  width: 16px;
  height: 16px;
  background: #7aa2ff;
  position: absolute;
  bottom: -8px;
  right: -8px;
  cursor: nwse-resize;
  border-radius: 4px;
}
.panel {
  background: #171923;
  border-radius: 12px;
  border: 1px solid #111520;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-width: 300px;
}
label {
  font-size: 13px;
  color: #a0a6b0;
}
input, select, button {
  font-size: 14px;
}
input[type=file], select, input[type=url], input[type=color] {
  width: 100%;
  padding: 6px;
  border-radius: 8px;
  border: 1px solid #1b2033;
  background: #0e111a;
  color: #e7eaf0;
}
input[type=range] {
  width: 100%;
}
button {
  padding: 8px 12px;
  background: #111520;
  color: #e7eaf0;
  border-radius: 8px;
  border: 1px solid #161a2a;
  cursor: pointer;
}
button.primary {
  background: #7aa2ff;
  color: #0c101a;
  border-color: #5d83ff;
}
.row {
  display: flex;
  gap: 8px;
  align-items: center;
}
.pill {
  background: #0f1322;
  padding: 2px 6px;
  border-radius: 999px;
  font-size: 12px;
}
</style>
</head>
<body>
<div class="wrap">
  <div class="stage-wrap">
    <div id="stage">
      <img id="shirtImg" alt="upload shirt" />
      <div id="overlayBox" hidden>
        <div id="overlayInner"></div>
        <div class="handle"></div>
      </div>
    </div>
    <div class="row">
      <button id="centerBtn">center</button>
      <button id="fitBtn">fit chest</button>
      <button class="primary" id="exportBtn" disabled>export</button>
    </div>
  </div>
  <div class="panel">
    <label>upload shirt</label>
    <input type="file" id="shirtInput" accept="image/*">
    <label>design</label>
    <select id="svgSelect"></select>
    <input type="url" id="customUrl" placeholder="or paste svg url">
    <button id="loadCustomBtn">load custom</button>
    <label>color</label>
    <input type="color" id="color" value="#000000">
    <label>opacity</label>
    <input type="range" id="opacity" min="0" max="100" value="100">
    <span class="pill" id="opacityPct">100%</span>
    <label>size</label>
    <input type="range" id="scale" min="10" max="120" value="40">
    <span class="pill" id="scalePct">40%</span>
    <label>rotation</label>
    <input type="range" id="rotation" min="-45" max="45" value="0">
    <span class="pill" id="rotDeg">0°</span>
  </div>
</div>

<script>
const SVG_LIST = [
  { label: "select a design…", url: "" },
  { label: "smiley", url: "https://raw.githubusercontent.com/chubblubdub/ShirtDesigner/main/smiley.svg" },
  { label: "heart", url: "https://raw.githubusercontent.com/chubblubdub/ShirtDesigner/main/heart.svg" },
  { label: "squiggle", url: "https://raw.githubusercontent.com/chubblubdub/ShirtDesigner/main/squiggle.svg" },
];
const shirtInput = document.getElementById('shirtInput');
const shirtImg = document.getElementById('shirtImg');
const stage = document.getElementById('stage');
const overlayBox = document.getElementById('overlayBox');
const overlayInner = document.getElementById('overlayInner');
const handle = overlayBox.querySelector('.handle');
const svgSelect = document.getElementById('svgSelect');
const customUrl = document.getElementById('customUrl');
const loadCustomBtn = document.getElementById('loadCustomBtn');
const colorInput = document.getElementById('color');
const opacityInput = document.getElementById('opacity');
const opacityPct = document.getElementById('opacityPct');
const scaleInput = document.getElementById('scale');
const scalePct = document.getElementById('scalePct');
const rotationInput = document.getElementById('rotation');
const rotDeg = document.getElementById('rotDeg');
const exportBtn = document.getElementById('exportBtn');
const centerBtn = document.getElementById('centerBtn');
const fitBtn = document.getElementById('fitBtn');
let sizePct = 40, rotationDeg = 0, pos = { xPct: 50, yPct: 50 }, isDragging=false, dragStart={}, boxStart={};
let isResizing = false;           // (existing behavior relies on this)
let currentSVGEl = null;          // added: reference to the loaded SVG root

// populate design list
SVG_LIST.forEach(({label,url},i)=>{
  const opt=document.createElement('option');
  opt.textContent=label; opt.value=url; if(i===0) opt.disabled=true;
  svgSelect.appendChild(opt);
});

// shirt loaders
shirtInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(file){
    const url = URL.createObjectURL(file);
    loadShirt(url);
  }
});
stage.addEventListener('dragover', e=>{e.preventDefault();});
stage.addEventListener('drop', e=>{
  e.preventDefault();
  if(e.dataTransfer.files.length){
    const file=e.dataTransfer.files[0];
    loadShirt(URL.createObjectURL(file));
  }
});
document.addEventListener('paste', e=>{
  const items = e.clipboardData.items;
  for(let item of items){
    if(item.type.indexOf("image")!==-1){
      const blob = item.getAsFile();
      loadShirt(URL.createObjectURL(blob));
    }
  }
});
function loadShirt(src){
  shirtImg.src=src;
  shirtImg.onload=()=>{
    stage.style.width=shirtImg.width+"px";
    stage.style.height=shirtImg.height+"px";
    exportBtn.disabled=false;
  };
}

// design loaders
svgSelect.addEventListener('change', ()=>loadSVG(svgSelect.value));
loadCustomBtn.addEventListener('click', ()=>loadSVG(customUrl.value));

// --- UPDATED: robust SVG color handling (force currentColor, then drive via CSS) ---
async function loadSVG(url){
  if(!url) return;
  const resp = await fetch(url);
  let text = await resp.text();

  // Remove any <style> blocks that might override fills/strokes
  text = text.replace(/<style[\s\S]*?<\/style>/gi, "");

  // Force all fills/strokes to currentColor so we can recolor via CSS
  text = text.replace(/fill="(.*?)"/gi, (m, v) => /none/i.test(v) ? m : 'fill="currentColor"');
  text = text.replace(/stroke="(.*?)"/gi, (m, v) => /none/i.test(v) ? m : 'stroke="currentColor"');

  overlayInner.innerHTML = text;
  currentSVGEl = overlayInner.querySelector('svg');

  if (currentSVGEl) {
    currentSVGEl.style.color = colorInput.value; // initial color
  }

  overlayBox.hidden = false;
  setOverlayTransform();
}

// recolor by updating CSS currentColor on the SVG root
function applyColor(root, color){
  if (root) root.style.color = color;
}

colorInput.addEventListener('input', ()=>{
  if (currentSVGEl) applyColor(currentSVGEl, colorInput.value);
});

opacityInput.addEventListener('input', ()=>{
  opacityPct.textContent=opacityInput.value+"%";
  overlayBox.style.opacity=opacityInput.value/100;
});
scaleInput.addEventListener('input', ()=>{
  sizePct=parseInt(scaleInput.value);
  scalePct.textContent=sizePct+"%";
  setOverlayTransform();
});
rotationInput.addEventListener('input', ()=>{
  rotationDeg=parseInt(rotationInput.value);
  rotDeg.textContent=rotationDeg+"°";
  setOverlayTransform();
});
centerBtn.addEventListener('click', ()=>{
  pos={xPct:50,yPct:50};
  setOverlayTransform();
});
fitBtn.addEventListener('click', ()=>{
  sizePct=50; pos={xPct:50,yPct:35};
  setOverlayTransform();
});

// drag / resize
overlayBox.addEventListener('mousedown', e=>{
  if(e.target===handle){
    isResizing=true;
  } else {
    isDragging=true;
  }
  dragStart={x:e.clientX, y:e.clientY};
  boxStart={...pos, size:sizePct};
  overlayBox.classList.add('dragging');
});
document.addEventListener('mousemove', e=>{
  if(isDragging){
    const rect=stage.getBoundingClientRect();
    const dx=(e.clientX-dragStart.x)/rect.width*100;
    const dy=(e.clientY-dragStart.y)/rect.height*100;
    pos.xPct=boxStart.xPct+dx;
    pos.yPct=boxStart.yPct+dy;
    setOverlayTransform();
  }
  if(isResizing){
    const rect=stage.getBoundingClientRect();
    const dx=(e.clientX-dragStart.x)/rect.width*100;
    sizePct=Math.max(5, boxStart.size+dx);
    scalePct.textContent=Math.round(sizePct)+"%";
    setOverlayTransform();
  }
});
document.addEventListener('mouseup', ()=>{
  isDragging=false;
  isResizing=false;
  overlayBox.classList.remove('dragging');
});

function setOverlayTransform(){
  overlayBox.style.left=pos.xPct+"%";
  overlayBox.style.top=pos.yPct+"%";
  overlayBox.style.width=sizePct+"%";
  overlayBox.style.transform=`translate(-50%,-50%) rotate(${rotationDeg}deg)`;
}

exportBtn.addEventListener('click', ()=>{
  const canvas=document.createElement('canvas');
  canvas.width=shirtImg.width;
  canvas.height=shirtImg.height;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(shirtImg,0,0);

  // Use the currently in-DOM SVG (already color-forced via currentColor)
  const svgData=new XMLSerializer().serializeToString(overlayInner.firstChild);
  const img=new Image();
  const svgBlob=new Blob([svgData],{type:"image/svg+xml;charset=utf-8"});
  const url=URL.createObjectURL(svgBlob);
  img.onload=()=>{
    ctx.globalAlpha=overlayBox.style.opacity || 1;
    const ow=overlayBox.offsetWidth;
    const oh=overlayBox.offsetHeight;
    const ox=(pos.xPct/100)*shirtImg.width-ow/2;
    const oy=(pos.yPct/100)*shirtImg.height-oh/2;
    ctx.drawImage(img, ox, oy, ow, oh);
    const link=document.createElement('a');
    link.download="shirt_mockup.png";
    link.href=canvas.toDataURL();
    link.click();
  };
  img.src=url;
});
</script>
</body>
</html>
